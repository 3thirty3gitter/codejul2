const express = require("express");
const cors = require("cors");
const fs = require("fs").promises;
const path = require("path");
require("dotenv").config();

const app = express();
app.use(cors());
app.use(express.json());

// --- CONFIGURATION ---
const PERPLEXITY_API_URL = "https://api.perplexity.ai/chat/completions";
const WORKSPACE_DIR = path.resolve(__dirname, '..', '..', 'generated-projects');

fs.mkdir(WORKSPACE_DIR, { recursive: true });

// Helper to create a secure file path
const getSafePath = (filePath) => {
  if (!filePath || typeof filePath !== 'string') throw new Error("Invalid path provided.");
  const resolvedPath = path.resolve(WORKSPACE_DIR, filePath);
  if (!resolvedPath.startsWith(WORKSPACE_DIR)) throw new Error("Access denied.");
  return resolvedPath;
};

// --- AGENT TOOLS ---
const tools = [
  { type: "function", function: { name: "listFiles", description: "List all files and directories recursively in the project workspace.", parameters: { type: "object", properties: {} } } },
  { type: "function", function: { name: "readFile", description: "Read the contents of a specific file.", parameters: { type: "object", properties: { path: { type: "string", description: "The relative path to the file." } }, required: ["path"] } } },
  { type: "function", function: { name: "writeFile", description: "Write content to a file, creating it if necessary.", parameters: { type: "object", properties: { path: { type: "string", description: "The relative path to the file." }, content: { type: "string", description: "The content to write." } }, required: ["path", "content"] } } }
];

const toolHandlers = {
  listFiles: async () => (await fs.readdir(WORKSPACE_DIR, { withFileTypes: true, recursive: true })).map(file => path.join(file.path.replace(WORKSPACE_DIR, ''), file.name)).join('\n'),
  readFile: async ({ path: filePath }) => fs.readFile(getSafePath(filePath), "utf-8"),
  writeFile: async ({ path: filePath, content }) => {
    const safePath = getSafePath(filePath);
    await fs.mkdir(path.dirname(safePath), { recursive: true });
    await fs.writeFile(safePath, content, "utf-8");
    return `Successfully wrote ${content.length} bytes to ${filePath}`;
  },
};

// --- FINAL, SIMPLIFIED, DIRECT SYSTEM PROMPT ---
const systemPrompt = `You are a file system bot. Your only purpose is to execute file operations based on user requests.
- You CANNOT search the web or answer questions.
- You can ONLY use the tools provided: 'listFiles', 'readFile', 'writeFile'.
- Refuse any request that is not a file operation by stating your purpose.
- MANDATORY: After every 'writeFile' call, your immediate next action must be to call 'readFile' on the same file to verify the content.`;

// --- NEW: ROOT STATUS ENDPOINT ---
app.get("/", (req, res) => {
  res.json({
    status: "online",
    agent: "Autonomous AI Software Engineer",
    message: "This is the backend API. It is not intended for direct browser access. Please use the frontend application."
  });
});

// --- MAIN CHAT ENDPOINT WITH ROBUST ERROR LOGGING ---
app.post("/api/chat", async (req, res) => {
  // (Chat logic remains unchanged)
  const history = req.body.messages || [];
  if (history.length === 0) return res.status(400).json({ error: "Messages are required" });

  try {
    let continueConversation = true;
    while (continueConversation) {
      const response = await fetch(PERPLEXITY_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${process.env.PERPLEXITY_API_KEY}` },
        body: JSON.stringify({
          model: "r1-1776",
          system: systemPrompt,
          messages: history,
          tools: tools,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        console.error("Perplexity API Error:", JSON.stringify(errorData, null, 2));
        throw new Error(`API request failed with status ${response.status}: ${errorData.error?.message || 'Unknown API error'}`);
      }

      const data = await response.json();
      const choice = data.choices && data.choices[0];
      
      if (!choice) {
        console.error("Invalid success response structure:", JSON.stringify(data, null, 2));
        throw new Error("Invalid response structure from AI service");
      }

      const { message } = choice;
      history.push(message);

      if (message.tool_calls && message.tool_calls.length > 0) {
        const toolResults = [];
        for (const toolCall of message.tool_calls) {
          const handler = toolHandlers[toolCall.function.name];
          if (handler) {
            const args = JSON.parse(toolCall.function.arguments);
            const result = await handler(args);
            toolResults.push({ tool_call_id: toolCall.id, content: result });
          }
        }
        history.push({ role: "tool", content: toolResults });
      } else {
        continueConversation = false;
        res.json(choice);
      }
    }
  } catch (error) {
    console.error("Tool-use loop error:", error.message);
    res.status(500).json({ error: "An error occurred during the conversation: " + error.message });
  }
});

const PORT = process.env.PORT || 3001;
app.listen(PORT, () => {
  console.log(`Autonomous AI Software Engineer is online on http://localhost:${PORT}`);
});
